{% extends "layout.html" %}

{% block content %}
<h1>Settings</h1>

<div class="card" style="padding: 0; overflow: hidden; background: transparent; box-shadow: none; border: none;">
    <!-- Tabs Navigation -->
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'general')">General</button>
        <button class="tab-btn" onclick="openTab(event, 'finance')">Finance & Bank</button>
        <button class="tab-btn" onclick="openTab(event, 'notifications')">Notifications</button>
        <button class="tab-btn" onclick="openTab(event, 'system')">System & Data</button>
    </div>

    <!-- Main Settings Form -->
    <form action="{{ url_for('settings') }}" method="POST">

        <!-- Tab: General -->
        <div id="general" class="tab-content active">
            <div class="card"> <!-- Wrapped in card for white bg and shadow -->
                <h3>Sender Information</h3>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" name="sender_name" value="{{ settings.get('sender_name', '') }}">
                </div>
                <div class="form-group">
                    <label>Address Line 1</label>
                    <input type="text" name="sender_address_line1"
                        value="{{ settings.get('sender_address_line1', '') }}">
                </div>
                <div class="form-group">
                    <label>Address Line 2</label>
                    <input type="text" name="sender_address_line2"
                        value="{{ settings.get('sender_address_line2', '') }}">
                </div>
                <div class="form-group">
                    <label>Address Line 3</label>
                    <input type="text" name="sender_address_line3"
                        value="{{ settings.get('sender_address_line3', '') }}">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="sender_email" value="{{ settings.get('sender_email', '') }}">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" name="sender_phone" value="{{ settings.get('sender_phone', '') }}">
                </div>
                <div class="form-group">
                    <label>Tax Identification Number</label>
                    <input type="text" name="tax_id" value="{{ settings.get('tax_id', '') }}">
                </div>
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </div>
        </div>

        <!-- Tab: Finance -->
        <div id="finance" class="tab-content">
            <div class="card">
                <h3>Bank Details</h3>
                <div class="form-group">
                    <label>IBAN</label>
                    <input type="text" name="bank_iban" value="{{ settings.get('bank_iban', '') }}">
                </div>
                <div class="form-group">
                    <label>Account Holder Name (for Payment)</label>
                    <input type="text" name="bank_account_holder" value="{{ settings.get('bank_account_holder', '') }}">
                </div>
                <div class="form-group">
                    <label>SWIFT / BIC</label>
                    <input type="text" name="bank_swift" value="{{ settings.get('bank_swift', '') }}">
                </div>

                <hr style="margin: 20px 0;">

                <h3>Finance</h3>
                <div class="form-group">
                    <label>VAT Percentage (%)</label>
                    <input type="number" name="vat_percentage" step="0.01"
                        value="{{ settings.get('vat_percentage', '11') }}">
                </div>
                <div class="form-group">
                    <label>Default VAT Exempt Message</label>
                    <textarea name="default_vat_exempt_reason" rows="3"
                        placeholder="Reason to display on PDF when VAT is 0%">{{ settings.get('default_vat_exempt_reason', '') }}</textarea>
                </div>
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </div>
        </div>

        <!-- Tab: Notifications -->
        <div id="notifications" class="tab-content">
            <div class="card">
                <h3>Notifications</h3>
                <div class="form-group">
                    <label>Discord Webhook URL</label>
                    <input type="text" name="discord_webhook_url" value="{{ settings.get('discord_webhook_url', '') }}"
                        placeholder="https://discord.com/api/webhooks/...">
                </div>

                <div class="form-group form-row">
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                    <button type="button" id="testWebhookBtn" class="btn btn-secondary">Test Webhook</button>
                </div>
            </div>
        </div>
    </form>

    <!-- Tab: System (Separate Forms) -->
    <div id="system" class="tab-content">
        <div class="card" style="background: transparent; box-shadow: none; border: none; padding: 0;">
            <h3>Data Management</h3>
            <div class="card-grid">
                <!-- Export Card -->
                <div class="data-card-wrapper">
                    <div class="data-card">
                        <h4>Export Data</h4>
                        <p>Download a full backup of your clients, invoices, and settings as a JSON file.</p>
                        <a href="{{ url_for('export_data') }}" class="btn btn-secondary"
                            style="margin-top: auto; text-align: center;">Download Backup</a>
                    </div>
                </div>

                <!-- Import Card -->
                <div class="data-card-wrapper">
                    <div class="data-card">
                        <h4>Import Data</h4>
                        <p>Restore data from a backup file. <strong>Warning: This overwrites all current data.</strong>
                        </p>

                        <form action="{{ url_for('import_data') }}" method="POST" enctype="multipart/form-data"
                            onsubmit="return confirm('WARNING: This will DELETE all current data and replace it with the imported file. This action cannot be undone. Proceed?');">

                            <div class="file-drop-area" onclick="document.getElementById('fileInput').click()">
                                <span class="fake-btn">Choose File</span>
                                <span class="file-msg">or drag and drop here</span>
                                <input type="file" id="fileInput" name="file" accept=".json" required
                                    onchange="updateFileMsg(this)">
                            </div>

                            <button type="submit" class="btn btn-warning"
                                style="width: 100%; background-color: #ffc107; border-color: #ffc107; color: #212529;">Import
                                JSON</button>
                        </form>
                    </div>
                </div>
            </div>

            <hr style="margin: 40px 0;">

            <h3>Application Control</h3>
            <div class="data-card" style="border-color: #f5c6cb; background: #fff8f8;">
                <h4 style="color: #dc3545; border-bottom-color: #f5c6cb;">Danger Zone</h4>
                <p>The application runs in the background. Use this button to fully terminate the process.</p>
                <form action="{{ url_for('shutdown') }}" method="POST"
                    onsubmit="return confirm('Are you sure you want to shut down the application?');">
                    <button type="submit" class="btn btn-danger">Shutdown Application</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

<script>
    function openTab(evt, tabName) {
        var i, tabContent, tabBtns;

        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].classList.remove("active");
        }

        tabBtns = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tabBtns.length; i++) {
            tabBtns[i].classList.remove("active");
        }

        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    // Reuse existing test button logic but ensure it listens to clicks correctly
    document.addEventListener('DOMContentLoaded', function () {
        // Tab switching logic is separate

        // Webhook Test Logic
        const testBtn = document.getElementById('testWebhookBtn');
        if (testBtn) {
            testBtn.addEventListener('click', async function () {
                const btn = this;
                const originalText = btn.innerText;
                const urlInput = document.querySelector('input[name="discord_webhook_url"]');
                const webhookUrl = urlInput ? urlInput.value : '';

                if (!webhookUrl) {
                    showToast("Please enter a Webhook URL first.", "error");
                    return;
                }

                btn.disabled = true;
                btn.innerText = "Testing...";

                const formData = new FormData();
                formData.append('discord_webhook_url', webhookUrl);

                try {
                    const response = await fetch("{{ url_for('test_discord_webhook') }}", {
                        method: 'POST',
                        body: formData
                    });

                    const text = await response.text();

                    if (response.ok) {
                        showToast(text, "success");
                    } else {
                        showToast("Error: " + text, "error");
                    }
                } catch (error) {
                    showToast("Network error occurred.", "error");
                } finally {
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            });
        }
    });

    function updateFileMsg(input) {
        var msgSpan = input.parentNode.querySelector('.file-msg');
        if (input.files && input.files.length > 0) {
            msgSpan.innerText = input.files[0].name;
        } else {
            msgSpan.innerText = "or drag and drop here";
        }
    }

    function showToast(message, type) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');

        toast.style.padding = '15px 25px';
        toast.style.marginTop = '10px';
        toast.style.borderRadius = '5px';
        toast.style.color = '#fff';
        toast.style.fontWeight = '500';
        toast.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s ease-in-out';

        if (type === 'success') {
            toast.style.backgroundColor = '#28a745';
        } else {
            toast.style.backgroundColor = '#dc3545';
        }

        toast.innerText = message;

        container.appendChild(toast);

        // Trigger reflow
        void toast.offsetWidth;

        toast.style.opacity = '1';

        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}